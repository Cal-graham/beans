{% extends "base.html" %}

{% block content %}
<div class="columns">
<div class="column is-12">
<div class="box has-background-grey-darker">
	<div class="block" style="position: relative; height:25vh; width:100vw">
	<canvas id="lineChart0"></canvas>
	</div>
</div>
<div class="box has-background-grey-darker">
        <div class="block" style="position: relative; height:25vh; width:100vw">
	<canvas id="lineChart1"></canvas>
	</div>
</div>
<div class="box has-background-grey-darker">
        <div class="block" style="position: relative; height:25vh; width:100vw">
	<canvas id="lineChart2"></canvas>
	</div>
</div>
</div>
</div>

<script>

    var record_button = document.navbar['record'];
    var stop_button = document.navbar['stop'];
    stop_button.style.display = 'none';

    var recording = 0;

    record_button.onclick = function(){
	recording = 1;
	console.log(recording)
	record_button.style.display = 'none';
	stop_button.style.display = 'inline';
    }

    stop_button.onclick = function(){
        recording = 0;
	console.log(recording)
        stop_button.style.display = 'none';
        record_button.style.display = 'inline';
    }

    var chartColors = {
        pressure: 'rgb(255, 255, 255)',
        grouphead: ['rgb(255, 0, 0)', 'rgb(255, 100, 0)', 'rgb(255, 0, 100)'],
        boiler: ['rgb(100, 0, 255)', 'rgb(0, 0, 255)', 'rgb(0, 100, 255)']
    };

    var color = Chart.helpers.color;
	
    var zeroDataSet = {
	data: [0],
        label: "template",
	backgroundColor: chartColors.pressure,
        borderColor: chartColors.pressure,
        pointBorderColor: chartColors.pressure,
        pointBackgroundColor: chartColors.pressure,
        fill: false,
        pointRadius: 0,
        outerGlowWidth: 40,
        outerGlowColor: chartColors.pressure,
        shadowBlur: 10,
        shadowColor: chartColors.pressure
    };
	    
    var baselineData = {
      labels: [''],
      datasets: [
	$.extend( true, {}, zeroDataSet),
	]
    };
	
    var lineOptions = {
        maintainAspectRatio: false,
        animation: false,
        layout: {
            padding:{
		left: 0,
		right: 0,
		top: 0,
		bottom: -10
	    }
        },
        scales:{
            xAxes: [{
                display: false
            }],
        },
        title: {
          display: false
        },
	elements: {
		point : {
			radius: 0
		}
	},
	legend: {
               	display: true,
		position: 'right',
      		labels: {
			color: chartColors.pressure
		}
	}
        }

    var lineChart0 = new Chart(document.getElementById("lineChart0"), {
      type: 'line',
      data: $.extend( true, {}, baselineData),
      options: lineOptions,
    });

    var lineChart1 = new Chart(document.getElementById("lineChart1"), {
      type: 'line',
      data: $.extend( true, {}, baselineData),
      options: lineOptions,
    });
	
    var lineChart2 = new Chart(document.getElementById("lineChart2"), {
      type: 'line',
      data: $.extend( true, {}, baselineData),
      options: lineOptions,
    });

    var refresh = function(recording){
        var requests = $.get('/main/read');
        var tm = requests.done(function(r){
		console.log(recording)
		ct = 1; cp = 1;	cf = 1;
		temps = [];
       		for (const [key, value] of Object.entries(r)){
			
			if (key.includes("temp")){
				lineChart0.data.datasets[ct].data.push(value)
				ct = ct + 1				
				console.log(key, lineChart0.data.datasets[ct-1].data)
			}
			if (key.includes("pressure")){
				lineChart1.data.datasets[cp].data.push(value)
				cp = cp + 1
			}
			if (key.includes("flow")){
				lineChart2.data.datasets[cf].data.push(value)
				cf = cf + 1
			}
			if (key.includes("time")){
				lineChart0.data.labels.push(value)
				lineChart1.data.labels.push(value)
				lineChart2.data.labels.push(value)
				if ((lineChart0.data.labels.length > 400 && recording == 0) || lineChart0.data.labels.length > 1000){
					lineChart0.data.labels.shift();
                                        lineChart0.data.datasets.forEach((dataset) => {
                                                dataset.data.shift();
                                        });
					lineChart0.data.datasets[0].data.push(0)
				}
				if ((lineChart1.data.labels.length > 400 && recording == 0) || lineChart1.data.labels.length > 1000){
					lineChart1.data.labels.shift();
                                        lineChart1.data.datasets.forEach((dataset) => {
                                                dataset.data.shift();
                                        });
					lineChart1.data.datasets[0].data.push(0)
				}
				if ((lineChart2.data.labels.length > 400 && recording == 0) || lineChart2.data.labels.length > 1000){
                                        lineChart2.data.labels.shift();
					lineChart2.data.datasets.forEach((dataset) => {
						dataset.data.shift();
					});
					lineChart2.data.datasets[0].data.push(0)
                                }
			}

		}
                lineChart0.update();
		lineChart1.update();
                lineChart2.update();
	sleep(200);
	refresh(recording);
        });
    }
    
    var init = function(){
        var requests = $.get('/main/read');
        var tm = requests.done(function(r){

		ct = 1; cp = 1;	cf = 1;
		color = 'rgb(255,255,255)'
		temps = [];
       		for (const [key, value] of Object.entries(r)){
			
			if (key.includes("temp")){
				add = $.extend( true, {}, zeroDataSet),
				add.label = key
				if (key.includes("boiler")){
					color = chartColors.boiler[ct]
				} else {
					color = chartColors.grouphead[ct]
				}
				add.backgroundColor = color
				add.borderColor = color
				add.pointBorderColor = color
				add.pointBackgroundColor = color
				add.fill = false
				add.pointRadius = 0
				add.outerGlowWidth = 40
				add.outerGlowColor = color
				add.shadowBlur = 10
				add.shadowColor = color
				lineChart0.data.datasets[ct] = (add)
				ct = ct + 1				
			}
			if (key.includes("pressure")){
				add = $.extend( true, {}, zeroDataSet),
				add.label = key
				color = chartColors.pressure
				add.backgroundColor = color
				add.borderColor = color
				add.pointBorderColor = color
				add.pointBackgroundColor = color
				add.fill = false
				add.pointRadius = 0
				add.outerGlowWidth = 40
				add.outerGlowColor = color
				add.shadowBlur = 10
				add.shadowColor = color
				lineChart1.data.datasets[cp] = add
				cp = cp + 1
			}
			if (key.includes("flow")){
				add = $.extend( true, {}, zeroDataSet),
				add.label = key
				color = chartColors.pressure
				add.backgroundColor = color
				add.borderColor = color
				add.pointBorderColor = color
				add.pointBackgroundColor = color
				add.fill = false
				add.pointRadius = 0
				add.outerGlowWidth = 40
				add.outerGlowColor = color
				add.shadowBlur = 10
				add.shadowColor = color
				lineChart2.data.datasets[cf] = add
				cf = cf + 1
			}
		}
		
                lineChart0.update();
		lineChart1.update();
                lineChart2.update();
        });
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    init();
    refresh(recording);

</script>

{% endblock %}
